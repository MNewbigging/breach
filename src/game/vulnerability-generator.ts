import { CorePasswordMetadata } from "./core-password-generator";

export type VulnerabilitySpec =
  | { type: "exact-length"; exactLength: number }
  | { type: "vowel-exact"; vowelCount: number }
  | { type: "sum"; sum: number }
  | { type: "duplicate-characters"; hasDuplicates: boolean };

export function getVulnHintFor(spec: VulnerabilitySpec) {
  switch (spec.type) {
    case "exact-length":
      return `Length is ${spec.exactLength}`;
    case "vowel-exact":
      return `Exactly ${spec.vowelCount} vowel${spec.vowelCount > 1 ? "s" : ""}`;
    case "sum":
      return `Sum is ${spec.sum}`;
    case "duplicate-characters":
      return `${spec.hasDuplicates ? "Has" : "no"} duplicate characters`;
  }
}

export function getVulnerabilitySpecs(passwordMeta: CorePasswordMetadata) {
  const specs: VulnerabilitySpec[] = [];

  specs.push({ type: "exact-length", exactLength: passwordMeta.length });
  specs.push({ type: "vowel-exact", vowelCount: passwordMeta.vowelCount });
  //specs.push({ type: "sum", sum: passwordMeta.sum });
  specs.push({
    type: "duplicate-characters",
    hasDuplicates: passwordMeta.hasDuplicateChars,
  });

  return specs;
}

export interface Vulnerability {
  spec: VulnerabilitySpec;
  test: (candidate: string) => boolean;
}

const isVowel = (c: string) => "AEIOU".includes(c);
const vowelCount = (s: string) => [...s].filter(isVowel).length;
const hasDuplicateChars = (s: string) => new Set(s).size !== s.length;
const sumLetters = (s: string) =>
  [...s].reduce((sum, ch) => sum + (ch.charCodeAt(0) - 64), 0);

export function compileVulnerability(spec: VulnerabilitySpec): Vulnerability {
  switch (spec.type) {
    case "exact-length":
      return { spec, test: (s: string) => s.length === spec.exactLength };
    case "vowel-exact":
      return { spec, test: (s: string) => vowelCount(s) === spec.vowelCount };
    case "sum":
      return { spec, test: (s: string) => sumLetters(s) === spec.sum };
    case "duplicate-characters":
      return {
        spec,
        test: (s: string) => hasDuplicateChars(s) === spec.hasDuplicates,
      };
  }
}
